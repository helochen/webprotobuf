<html>
	<head></head>
	<script type="text/javascript" src="reconnecting-websocket.min.js"></script>
	<script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="node_modules/protobufjs/dist/protobuf.js"></script>
	<script src="endianMode/bufferHeader.js"></script>
	
	<script type="text/javascript" >
		var url = "ws://127.0.0.1:1024/";
		var options = {
			debug:true,
			reconnectInterval:3000
		};
		
		
		//var socket = new WebSocket(url);
		var socket = new ReconnectingWebSocket(url, null, options);
		
		socket.onopen = function(){
			console.log("open");
		};
		
		socket.onclose = function(e){
			console.log("close");
		};
		
		var fileReader = new FileReader();
		
		fileReader.addEventListener("loadend",function(){
			console.log("end........");
			if(fileReader.readyState == 2){
				var s_data = new DataView(fileReader.result);
				console.log(s_data.getUint32(0));
				console.log(s_data.getUint32(1));
				for(var i = 0; i < s_data.getUint32(0);++i){
					console.log(s_data.getUint8(8+i));
				}
				console.log(s_data.buffer);
				
			}
		});
		
		socket.onmessage = function(event){
			fileReader.readAsArrayBuffer(event.data);
		}
		
		//var protobuf = require("protobufjs/light");
		
		function sendMsg(buffer){
			console.log("buffer:" + buffer);
			socket.send(buffer);
		}
		
		
		///////////////////////////////
		protobuf.load("proto/awesome.proto", function(err, root) {
			if (err)
				throw err;

			// Obtain a message type
			var AwesomeMessage = root.lookupType("awesomepackage.AwesomeMessage");

			// Exemplary payload
			var payload = { awesomeField: "AwesomeString" };

			// Verify the payload if necessary (i.e. when possibly incomplete or invalid)
			var errMsg = AwesomeMessage.verify(payload);
			if (errMsg)
				throw Error(errMsg);

			// Create a new message
			var message = AwesomeMessage.create(payload); // or use .fromObject if conversion is necessary

			// Encode a message to an Uint8Array (browser) or Buffer (node)
			var buffer = AwesomeMessage.encode(message).finish();
			// ... do something with buffer
			var designBytes = new ArrayBuffer(buffer.length + 8);
			var view = new DataView(designBytes);
			setCommandAndLength(view , buffer.length + 4 , 10000);
			
			for(var i= 0 ; i < buffer.length ; ++i){
				view.setUint8(8 + i, buffer[i]);
			}
			sendMsg(designBytes);
			// Decode an Uint8Array (browser) or Buffer (node) to a message
			var message = AwesomeMessage.decode(buffer);
			// ... do something with message

			// If the application uses length-delimited buffers, there is also encodeDelimited and decodeDelimited.

			// Maybe convert the message back to a plain object
			var object = AwesomeMessage.toObject(message, {
				longs: String,
				enums: String,
				bytes: String,
				// see ConversionOptions
			});
		});
	</script>
	
	
	<body>
		<h2>Im Body</h2>
		
		<input value="click" text="click2Send" type="button" onclick="sendMsg()"/>
		
	</body>

</html>